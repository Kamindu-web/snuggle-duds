{% comment %}
  Product Suggestions Section
  - Displays "Complete The Look" / related products from a collection.
  - Prioritizes the collection(s) assigned via the product metafield "custom.product_category".
  - Falls back to the global collection if available; otherwise, uses a fallback collection set in section settings.
  - Excludes the current product.
  - Shows up to 3 products in a 3â€‘column grid.
{% endcomment %}

{% assign current_collection = blank %}
{% if product.metafields.custom.product_category and product.metafields.custom.product_category.size > 0 %}
    {% assign current_collection = product.metafields.custom.product_category %}
{% elsif collection %}
  {% assign current_collection = collection %}
{% elsif section.settings.fallback_collection != blank %}
  {% assign current_collection = collections[section.settings.fallback_collection] %}
{% endif %}


  {% for field in product.metafields.custom %}
    <p>Key: {{ field.first }} / Value: {{ field.last }}</p>
  {% endfor %}
  {% assign coll_handle = product.metafields.custom.product_category | strip %}
  {% assign current_collection = collections[coll_handle] %}
  Collection Title: {{ current_collection.title }}
  Collection URL: {{ current_collection.url }}

    

{% if current_collection and current_collection.products.size > 1 %}
  <style>
    .complete-the-look-section {
      margin: 40px 0;
    }
    .complete-the-look-heading {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.75em;
    }
    .complete-the-look-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
  </style>

  <section class="complete-the-look-section">
    <h2 class="complete-the-look-heading">{{ section.settings.heading }}</h2>
    <div class="complete-the-look-grid">
      {% assign count = 0 %}
      {% for related_product in current_collection.products %}
        {% if related_product.id != product.id %}
          {% render 'card-product', product: related_product %}
          {% assign count = count | plus: 1 %}
          {% if count == 3 %}{% break %}{% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Product Suggestions",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Complete The Look"
    },
    {
      "type": "collection",
      "id": "fallback_collection",
      "label": "Fallback Collection (if no collection context)"
    }
  ],
  "presets": [
    {
      "name": "Product Suggestions"
    }
  ]
}
{% endschema %}
